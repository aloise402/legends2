<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Liga Legends 2</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <main class="container">
    <h1>‚öæ Liga Legends 2</h1>
    <p id="last-updated" class="muted"></p>
    <p id="loading">Cargando datos...</p>
    <p id="error" class="error hidden"></p>

    <!-- ================= STANDINGS ================= -->
    <section id="standings-section">
      <h2>üìä Tabla de Posiciones</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Equipo</th>
            <th>Jugador</th>
            <th class="num">Prog</th>
            <th class="num">JJ</th>
            <th class="num">W</th>
            <th class="num">L</th>
            <th class="num">Por jugar</th>
          </tr>
        </thead>
        <tbody id="standings-body"></tbody>
      </table>
    </section>

    <!-- ================= GAMES TODAY ================= -->
    <section id="games-today-section">
      <h2>üìÖ Juegos del d√≠a</h2>
      <ul id="games-today-list"></ul>
    </section>
  </main>

  <script>
    const el = {
      loading: document.getElementById('loading'),
      error: document.getElementById('error'),
      updated: document.getElementById('last-updated'),
      standingsSection: document.getElementById('standings-section'),
      standingsBody: document.getElementById('standings-body'),
      gamesSection: document.getElementById('games-today-section'),
      gamesList: document.getElementById('games-today-list')
    };
    const show = x => x.classList.remove('hidden');
    const hide = x => x.classList.add('hidden');

    async function loadData(){
      hide(el.error);
      show(el.loading);
      try{
        const r = await fetch('/api/full', {cache:'no-store'});
        if(!r.ok){
          let msg = `HTTP ${r.status}`;
          try{ const j = await r.json(); if (j && j.error) msg = j.error; }catch(_){}
          throw new Error(msg);
        }
        const data = await r.json();

        if (data.last_updated) {
          el.updated.textContent = `√öltima actualizaci√≥n: ${data.last_updated}`;
          show(el.updated);
        }

        // Standings
        el.standingsBody.innerHTML = '';
        (data.standings || []).forEach((row, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${row.team}</td>
            <td><span class="tag">${row.user}</span></td>
            <td class="num">${row.scheduled}</td>
            <td class="num">${row.played}</td>
            <td class="num">${row.wins}</td>
            <td class="num">${row.losses}</td>
            <td class="num">${row.remaining}</td>
          `;
          el.standingsBody.appendChild(tr);
        });

        // Juegos del d√≠a
        el.gamesList.innerHTML = '';
        const games = data.games_today || [];
        if (games.length === 0) {
          el.gamesList.innerHTML = `<li class="muted">No hay juegos programados hoy.</li>`;
        } else {
games.forEach(g => {
  const li = document.createElement('li');

  // Dividimos: "Phillies 2 - Yankees 3 | 30-09-2025 - 1:12 am (hora Chile)"
  let [score, time] = g.split("|").map(s => s.trim());

  // Parsear equipos y marcador
  let parts = score.match(/(.+?) (\\d+) - (.+?) (\\d+)/);
  if (parts) {
    const [, team1, runs1, team2, runs2] = parts;

    li.innerHTML = `
      <span class="team1">${team1}</span> 
      <span class="runs">${runs1}</span> - 
      <span class="team2">${team2}</span> 
      <span class="runs">${runs2}</span>
      <br>
      <span class="time">${time}</span>
    `;
  } else {
    li.textContent = g; // fallback si no cumple formato
  }

  el.gamesList.appendChild(li);
});

        }
        show(el.gamesSection);

      }catch(e){
        el.error.textContent = 'No se pudieron cargar los datos: ' + e.message;
        show(el.error);
      }finally{
        hide(el.loading);
      }
    }

    loadData();
  </script>

  <!-- ================= CONSULTA DE LOCAL√çA ================= -->
  <section id="consulta-localia" class="card" style="margin-top:20px; padding:16px;">
    <h2>‚öæ Consulta de Local√≠a</h2>
    <div style="margin:10px 0;">
      <label for="equipoA">Equipo A:</label>
      <select id="equipoA" class="input"></select>

      <label for="equipoB" style="margin-left:12px;">Equipo B:</label>
      <select id="equipoB" class="input"></select>

      <button class="btn" style="margin-left:12px;" onclick="consultarLocalia()">Consultar</button>
    </div>
    <p id="resultado-localia" class="muted" style="margin-top:12px;"></p>
  </section>

  <script>
    const equipos = [
      "Mariners","Dodgers","Padres","Yankees","Phillies","Astros",
      "Mets","Brewers","Braves","Cubs","Reds","Diamondbacks","Red Sox"
    ];

    const localias = {
      "Yankees-Phillies": "Phillies",
      "Diamondbacks-Yankees": "Yankees",
      "Diamondbacks-Braves": "Braves",
      "Mets-Dodgers": "Dodgers",
      "Brewers-Mets": "Mets",
      "Cubs-Dodgers": "Dodgers"
      // ... resto de los juegos balanceados
    };

    const selA = document.getElementById("equipoA");
    const selB = document.getElementById("equipoB");
    equipos.forEach(eq => {
      selA.add(new Option(eq, eq));
      selB.add(new Option(eq, eq));
    });

    function consultarLocalia(){
      const a = selA.value, b = selB.value;
      if(a === b){
        document.getElementById("resultado-localia").innerText = "‚ö†Ô∏è Elige equipos distintos";
        return;
      }
      const clave1 = a+"-"+b, clave2 = b+"-"+a;
      const local = localias[clave1] ?? localias[clave2];
      document.getElementById("resultado-localia").innerText = `üèüÔ∏è El local es: ${local}`;
    }
  </script>
</body>
</html>